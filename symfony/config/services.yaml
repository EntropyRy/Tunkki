parameters:
  symfony:
    containerXmlPath: var/cache/dev/App_KernelDevDebugContainer.xml
  recording.host: "%env(RECORDING_HOST)%"
  recording.port: "%env(RECORDING_PORT)%"
  recording.user: "%env(RECORDING_USER)%"
  recording.pass: "%env(RECORDING_PASS)%"
  recording.script.start: "%env(RECORDING_SCRIPT_START)%"
  recording.script.stop: "%env(RECORDING_SCRIPT_STOP)%"
  recording.script.check: "%env(RECORDING_SCRIPT_CHECK)%"

  mattermost_client_id: "%env(MM_CLIENT_ID)%"
  mattermost_client_secret: "%env(MM_CLIENT_SECRET)%"
  mattermost_redirect_route: "%env(MM_REDIRECT)%"
  booking_notification_email: "%env(BOOKING_NOTIFICATION_EMAIL)%"
  mailer_sender_address: "webmaster@entropy.fi"
  door_socket: "%env(DOOR_SOCKET)%"
  router.request_context.scheme: "%env(SCHEME)%"
  stripe_public_key: "%env(STRIPE_PUBLISHABLE_KEY)%"
  stripe_secret_key: "%env(STRIPE_SECRET_KEY)%"

  mattermost_channels:
    yhdistys: "us4g1ifbn7df7b3ds373y94uow"
    vuokraus: "9fmbdfkutpdnfnn8oqupqmw3yy"
    nakkikone: "ixph3m1jxfny7rmy78yff3en5h"
    kerde: "kb7j8tb5b3bsfg8tym9jd9ro9r"

services:
  App\Service\Rental\Booking\BookingReferenceService:
    arguments:
      $referenceAdd: 1220
      $referenceStart: 303

  App\Service\ZMQService:
    arguments:
      $environment: "%kernel.environment%"

  _defaults:
    autowire: true
    autoconfigure: true

  App\:
    resource: "../src/"
    exclude:
      - "../src/DependencyInjection/"
      - "../src/Entity/"
      - "../src/Kernel.php"
      - "../src/Tests/"
      - "../src/Site/"
      - "../src/Factory/"
      - "../src/Story/"
      - "../src/Command/CmsSeedCommand.php"

  Twig\Extension\StringLoaderExtension:

  # EPics service interface binding
  App\Service\EPicsServiceInterface: '@App\Service\EPicsService'

  Sonata\PageBundle\CmsManager\CmsManagerSelectorInterface: "@sonata.page.cms_manager_selector"
  Sonata\PageBundle\CmsManager\CmsManagerSelector: "@sonata.page.cms_manager_selector"
  Sonata\MediaBundle\Provider\ImageProvider: "@sonata.media.provider.image"
  Sonata\PageBundle\Service\Contract\CreateSnapshotBySiteInterface: "@sonata.page.service.create_snapshot"

  # Override Sonata Media controller to fix category handling when categories are disabled
  sonata.media.controller.media.admin:
    class: App\Controller\Admin\MediaAdminController
    tags: ["controller.service_arguments"]

  Symfony\UX\Icons\Registry\LocalSvgIconRegistry:
    arguments:
      - "%kernel.project_dir%/assets/icons"
  Symfony\UX\Icons\Twig\IconFinder:
    arguments:
      - "@twig"
      - "%kernel.project_dir%/assets/icons"

  entropy.menu_builder:
    class: App\Menu\MenuBuilder
    tags:
      - { name: knp_menu.menu_builder, method: createMainMenu, alias: mainMenu }

  admin.door_log:
    class: App\Admin\DoorLogAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\DoorLog
        manager_type: orm
        group: admin
        label: Door Log

  entropy.admin.item:
    class: App\Admin\Rental\Inventory\ItemAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.item
        manager_type: orm
        group: admin
        audit: true
        label: Items
        model_class: App\Entity\Rental\Inventory\Item
        controller: App\Controller\Admin\Rental\Inventory\ItemAdminController
    calls:
      - [
          setTemplate,
          [outer_list_rows_mosaic, admin/item/list_outer_rows_mosaic.html.twig],
        ]
      - [setTemplate, [inner_list_row, admin/item/list.html.twig]]
      - [
          setTemplate,
          [base_list_field, admin/crud/base_list_flat_field.html.twig],
        ]
      - [addChild, ["@entropy.admin.statusevent", "item"]]
      - [addChild, ["@entropy.admin.file", "product"]]

  entropy.admin.statusevent:
    class: App\Admin\Rental\StatusEventAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.statusevent
        model_class: App\Entity\Rental\StatusEvent
        manager_type: orm
        group: admin
        label: Status Events
        show_mosaic_button: false

  entropy.admin.file:
    class: App\Admin\Rental\Inventory\FileAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.file
        model_class: App\Entity\Rental\Inventory\File
        manager_type: orm
        group: admin
        label: Files
        show_mosaic_button: false

  entropy.admin.member:
    class: App\Admin\MemberAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Member
        controller: App\Controller\Admin\MemberAdminController
        manager_type: orm
        group: admin
        label: Members

  entropy.page.stream:
    class: App\PageService\StreamPage
    arguments:
      - "Stream Page"
      - "@sonata.page.template_manager"
      - "@doctrine.orm.entity_manager"
    tags:
      - { name: sonata.page, alias: stream }

  entropy.page.eventspage:
    class: App\PageService\EventsPage
    arguments:
      $name: "Events"
      $security: "@security.helper"
    tags:
      - { name: sonata.page, alias: eventspage }

  sonata.page.service.default:
    class: App\PageService\DefaultPageService
    arguments:
      $name: Default

  App\PageService\FrontPage:
    arguments:
      $name: "Front Page"
    tags:
      - { name: sonata.page, alias: frontpage }

  entropy.admin.booking:
    class: App\Admin\Rental\Booking\BookingAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.booking
        model_class: App\Entity\Rental\Booking\Booking
        controller: App\Controller\Admin\Rental\BookingAdminController
        manager_type: orm
        group: admin
        audit: true
        label: Bookings
        show_mosaic_button: false
    calls:
      - [setTemplate, [edit, admin/booking/_edit_rentals.html.twig]]
      - [setTemplate, [inner_list_row, admin/booking/list.html.twig]]
      - [
          setTemplate,
          [base_list_field, admin/crud/base_list_flat_field.html.twig],
        ]
      - [addChild, ["@entropy.admin.statusevent", "booking"]]

  # Clock abstraction (STAN-03) - production/default
  App\Time\AppClock:
    class: App\Time\AppClock
  App\Time\ClockInterface: '@App\Time\AppClock'

  # (Other service definitions omitted for brevity in this edited section — retained below unchanged)

  entropy.admin.package:
    class: App\Admin\Rental\Inventory\PackageAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.package
        model_class: App\Entity\Rental\Inventory\Package
        manager_type: orm
        group: admin
        label: Packages

  entropy.admin.renter:
    class: App\Admin\Rental\Booking\RenterAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.renter
        model_class: App\Entity\Rental\Booking\Renter
        manager_type: orm
        group: admin
        label: Renters

  entropy.admin.billable_event:
    class: App\Admin\Rental\Booking\BillableEventAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.billable_event
        model_class: App\Entity\Rental\Booking\BillableEvent
        manager_type: orm
        group: admin
        label: Billable Events

  entropy_tunkki.block.bookings:
    class: App\Block\BookingsBlock
    tags:
      - { name: sonata.block, alias: bookingblock }

  entropy.block.joinus:
    class: App\Block\JoinUsBlock
    tags:
      - { name: sonata.block, alias: joinusblock }

  entropy_tunkki.block.linklist:
    class: App\Block\LinkListBlock
    tags:
      - { name: sonata.block, alias: linklistblock }

  entropy.block.future_events:
    class: App\Block\FutureEventsBlock
    tags:
      - { name: sonata.block, alias: futureeventsblock }

  entropy.admin.who_can_rent_choice:
    class: App\Admin\Rental\Inventory\WhoCanRentChoiceAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.who_can_rent_choice
        model_class: App\Entity\Rental\Inventory\WhoCanRentChoice
        manager_type: orm
        group: admin
        label: Who Can Rent Choices

  entropy.admin.accessory:
    class: App\Admin\Rental\Inventory\AccessoryAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.accessory
        model_class: App\Entity\Rental\Inventory\Accessory
        manager_type: orm
        group: admin
        label: Accessory

  entropy.admin.accessory_choices:
    class: App\Admin\Rental\Inventory\AccessoryChoiceAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.accessory_choices
        model_class: App\Entity\Rental\Inventory\AccessoryChoice
        manager_type: orm
        group: admin
        label: Accessories

  App\EventSubscriber\Rental\Booking\BookingAdminSubscriber:
    arguments:
      $email: "%booking_notification_email%"
      $fromEmail: "%mailer_sender_address%"

  admin.email:
    class: App\Admin\EmailAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Email
        controller: App\Controller\Admin\EmailAdminController
        manager_type: orm
        group: admin
        label: Emails

  entropy.admin.reward:
    class: App\Admin\Rental\Booking\RewardAdmin
    tags:
      - name: sonata.admin
        code: entropy.admin.reward
        model_class: App\Entity\Rental\Booking\Reward
        controller: App\Controller\Admin\Rental\Booking\RewardAdminController
        manager_type: orm
        group: admin
        label: Rewards

  entropy.admin.contract:
    class: App\Admin\ContractAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Contract
        manager_type: orm
        group: admin
        label: Contracts

  entropy.admin.event:
    class: App\Admin\EventAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Event
        controller: App\Controller\Admin\EventAdminController
        manager_type: orm
        group: admin
        label: Events
    calls:
      - [addChild, ["@admin.event_artist_info", "Event"]]
      - [addChild, ["@entropy.admin.nakki_booking", "event"]]
      - [addChild, ["@entropy.admin.rsvp", "event"]]
      - [addChild, ["@admin.ticket", "event"]]
      - [addChild, ["@admin.email", "event"]]
      - [addChild, ["@admin.notification", "event"]]
      - [addChild, ["@admin.happening", "event"]]

  admin.event_artist_info:
    class: App\Admin\EventArtistInfoAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\EventArtistInfo
        manager_type: orm
        group: admin
        label: EventArtistInfo
    calls:
      - [setTemplate, [inner_list_row, admin/event_artist_info/list.html.twig]]
      - [
          setTemplate,
          [base_list_field, admin/crud/base_list_flat_field.html.twig],
        ]

  entropy.admin.menu:
    class: App\Admin\MenuAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Menu
        controller: App\Controller\Admin\MenuAdminController
        manager_type: orm
        group: admin
        label: Menu

  entropy.admin.access_groups:
    class: App\Admin\AccessGroupsAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\AccessGroups
        manager_type: orm
        group: admin
        label: User Accessgroups

  entropy.admin.rsvp:
    class: App\Admin\RSVPAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\RSVP
        manager_type: orm
        group: admin
        label: RSVPs

  entropy.admin.nakki_definition:
    class: App\Admin\NakkiDefinitionAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\NakkiDefinition
        manager_type: orm
        group: admin
        label: Nakki Definitions

  entropy.admin.nakkikone:
    class: App\Admin\NakkikoneAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Nakkikone
        manager_type: orm
        group: admin
        label: Nakkikone

  entropy.admin.nakki:
    class: App\Admin\NakkiAdmin
    tags:
      - name: sonata.admin
        manager_type: orm
        group: admin
        label: Old Nakkikone
        model_class: App\Entity\Nakki
        controller: App\Controller\Admin\NakkiAdminController

  entropy.admin.nakki_booking:
    class: App\Admin\NakkiBookingAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\NakkiBooking
        manager_type: orm
        group: admin
        label: Nakki Bookings

  admin.ticket:
    class: App\Admin\TicketAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Ticket
        controller: App\Controller\Admin\TicketAdminController
        manager_type: orm
        group: admin
        label: Tickets

  admin.notification:
    class: App\Admin\NotificationAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Notification
        controller: App\Controller\Admin\NotificationAdminController
        manager_type: orm
        group: admin
        label: Notification

  admin.happening:
    class: App\Admin\HappeningAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Happening
        manager_type: orm
        group: admin
        label: Happening
    calls:
      - [addChild, ["@admin.happening_booking", "happening"]]

  admin.happening_booking:
    class: App\Admin\HappeningBookingAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\HappeningBooking
        manager_type: orm
        group: admin
        label: Happening Bookings

  admin.location:
    class: App\Admin\LocationAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Location
        manager_type: orm
        group: admin
        label: Location

  admin.product:
    class: App\Admin\ProductAdmin
    tags:
      - name: sonata.admin
        model_class: App\Entity\Product
        manager_type: orm
        group: admin
        label: Products

  admin.checkout:
    class: App\Admin\CheckoutAdmin
    tags:
      - {
          name: sonata.admin,
          model_class: App\Entity\Checkout,
          controller: App\Controller\Admin\CheckoutAdminController,
          manager_type: orm,
          group: admin,
          label: Checkouts,
        }

when@dev:
  services:
    # Register Factory and Story classes for dev environment
    App\Factory\:
      resource: "../src/Factory/"
      autowire: true
      autoconfigure: true
    App\Story\:
      resource: "../src/Story/"
      autowire: true
      autoconfigure: true
    App\Command\CmsSeedCommand:
      autowire: true
      autoconfigure: true

when@test:
  framework:
    mailer:
      dsn: "null://null"
    messenger:
      transports:
        # Force synchronous transport in tests to avoid async worker requirements
        async: "sync://"
    notifier:
      # Disable external notifications in tests
      chatter_transports: []
      texter_transports: []
      channel_policy:
        # Route everything to null channel
        urgent: []
        high: []
        medium: []
        low: []
  parameters:
    test.fixed_datetime: "2025-01-01T12:00:00+02:00"
    stripe_public_key: "pk_test_dummy"
    stripe_secret_key: "sk_test_dummy"
  services:
    # Register Factory and Story classes for test environment
    App\Factory\:
      resource: "../src/Factory/"
      autowire: true
      autoconfigure: true
    App\Story\:
      resource: "../src/Story/"
      autowire: true
      autoconfigure: true
    App\Command\CmsSeedCommand:
      autowire: true
      autoconfigure: true
    App\Tests\Support\Stripe\FakeStripeService:
      public: true
      arguments:
        $urlG: "@router"
        $clock: "@App\\Time\\ClockInterface"
    App\Service\StripeServiceInterface:
      alias: App\Tests\Support\Stripe\FakeStripeService
      public: true
    App\Service\StripeService:
      alias: App\Tests\Support\Stripe\FakeStripeService
      public: true

    # Primary mutable test clock binding (replaces prior FixedClock usage)
    App\Time\ClockInterface:
      class: App\Time\MutableClock
      arguments:
        - "%test.fixed_datetime%"
      public: true

    # Explicit alias to retrieve the mutable clock directly if desired
    test.mutable_clock:
      alias: App\Time\ClockInterface
      public: true

    # Backwards compatible alias for legacy references to test.fixed_clock
    test.fixed_clock:
      alias: App\Time\ClockInterface
      public: true

    # (Removed SingleSiteSelector test stub & aliases – relying on real Sonata site selection for tests)

    # Fake EPics service for testing
    App\Tests\Support\EPics\FakeEPicsService:
      public: true
    App\Service\EPicsServiceInterface:
      alias: App\Tests\Support\EPics\FakeEPicsService
      public: true

    App\Tests\Support\Notifier\TestChatter:
      public: true
    Symfony\Component\Notifier\ChatterInterface:
      alias: App\Tests\Support\Notifier\TestChatter
      public: true

    App\Tests\Support\Kerde\FakeSSHService:
      public: true
    App\Service\SSHServiceInterface:
      alias: App\Tests\Support\Kerde\FakeSSHService
      public: true
    App\Service\SSHService:
      alias: App\Tests\Support\Kerde\FakeSSHService
      public: true

    App\Tests\Support\Kerde\FakeZMQService:
      public: true
    App\Service\ZMQServiceInterface:
      alias: App\Tests\Support\Kerde\FakeZMQService
      public: true
    App\Service\ZMQService:
      alias: App\Tests\Support\Kerde\FakeZMQService
      public: true

when@panther:
  services:
    # Register Factory and Story classes for panther test environment
    App\Factory\:
      resource: "../src/Factory/"
      autowire: true
      autoconfigure: true
    App\Story\:
      resource: "../src/Story/"
      autowire: true
      autoconfigure: true
    App\Command\CmsSeedCommand:
      autowire: true
      autoconfigure: true
