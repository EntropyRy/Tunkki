{% set attrs = attributes.defaults({ class: 'nakki-board' }) %}
<div{{ attrs }}>
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">{{ 'Nakkikone Planner'|trans }}</h2>
        </div>
        <div class="card-body">
            {% if this.error %}
                <div class="alert alert-warning" role="alert">{{ this.error }}</div>
            {% endif %}
            {% if this.message %}
                <div class="alert alert-success" role="status">{{ this.message }}</div>
            {% endif %}

            {{ form_start(form, {
                attr: {
                    class: 'row g-3 align-items-end',
                    'data-action': 'live#action:prevent',
                    'data-live-action-param': 'addColumn'
                }
            }) }}
                <div class="col-12 col-lg-4">
                    {{ form_row(form.definition) }}
                </div>
                <div class="col-12 col-lg-2 d-flex align-items-end">
                    <button type="button"
                            class="btn btn-outline-secondary w-100"
                            data-action="live#emit"
                            data-live-event-name-param="definition:new">
                        {{ 'Add new definition'|trans }}
                    </button>
                </div>
                {% set selectedDefinitionEntity = form.definition.vars.data %}
                {% set selectedDefinitionId = selectedDefinitionEntity ? selectedDefinitionEntity.id : (form.definition.vars.value ?? null) %}
                {% if selectedDefinitionId is not null %}
                    {% set selectedDefinitionId = selectedDefinitionId|default(null) %}
                {% endif %}
                <div class="col-12">
                    <div class="card card-body">
                            {% if selectedDefinitionId %}
                                {% set meta = definitionMeta[selectedDefinitionId] ?? null %}
                                <div class="accordion mb-3" id="nakki-definition-preview">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="definition-preview-heading">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#definition-preview-body" aria-expanded="true">
                                                {% if meta %}
                                                    {{ meta.definition.nameFi }} / {{ meta.definition.nameEn }}
                                                {% else %}
                                                    {{ 'Definition'|trans }}
                                                {% endif %}
                                            </button>
                                        </h2>
                                        <div id="definition-preview-body" class="accordion-collapse collapse show" data-bs-parent="#nakki-definition-preview">
                                            <div class="accordion-body">
                                                {% if meta %}
                                                    <div class="mb-3">
                                                        <h5 class="h6 fw-semibold">{{ 'Finnish description'|trans }}</h5>
                                                        <div>{{ meta.definition.descriptionFi|raw }}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <h5 class="h6 fw-semibold">{{ 'English description'|trans }}</h5>
                                                        <div>{{ meta.definition.descriptionEn|raw }}</div>
                                                    </div>
                                                    {% if meta.definition.onlyForActiveMembers %}
                                                        <span class="badge bg-warning text-dark">{{ 'Only for active members'|trans }}</span>
                                                    {% endif %}
                                                    <div class="mt-3">
                                                        {% if meta.events %}
                                                            {% for event in meta.events %}
                                                                <span class="badge bg-info text-dark me-1">{{ event.getNameByLang(app.request.locale) }}</span>
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted small">{{ 'Definition not used yet.'|trans }}</span>
                                                        {% endif %}
                                                    </div>
                                                    <button type="button"
                                                            class="btn btn-outline-primary btn-sm mt-3"
                                                            data-action="live#emit"
                                                            data-live-event-name-param="definition:edit"
                                                            data-live-definition-id-param="{{ meta.definition.id }}"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#nakki-definition-editor"
                                                            aria-expanded="true">
                                                        {{ 'Edit definition'|trans }}
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted small">{{ 'Definition details unavailable.'|trans }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            <twig:Nakki:DefinitionForm :definitionId="selectedDefinitionId" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 col-lg-3">
                    {{ form_row(form.startAt) }}
                </div>
                <div class="col-12 col-md-4 col-lg-3">
                    {{ form_row(form.endAt) }}
                </div>
                <div class="col-6 col-md-3 col-lg-2">
                    {{ form_row(form.intervalHours) }}
                </div>
                <div class="col-6 col-md-3 col-lg-3">
                    {{ form_row(form.responsible) }}
                </div>
                <div class="col-12 col-lg-4">
                    {{ form_row(form.mattermostChannel) }}
                </div>
                <div class="col-12 col-lg-3 text-lg-end">
                    <button type="submit" class="btn btn-primary w-100">{{ 'Add column'|trans }}</button>
                </div>
            {{ form_end(form, { render_rest: false }) }}
        </div>
    </div>

    <div class="row row-cols-1 row-cols-lg-2 g-3">
        {% for nakki in this.columns %}
            <div class="col">
                <twig:Nakki:Column :nakkiId="nakki.id" />
            </div>
        {% else %}
            <div class="col">
                <div class="alert alert-info mb-0">{{ 'No Nakkis configured yet.'|trans }}</div>
            </div>
        {% endfor %}
    </div>
</div>
