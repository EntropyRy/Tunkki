{% set nakki = this.nakkiView %}
{% set attrs = attributes.defaults({class: 'nakki-column card shadow-sm border-0 h-100'}) %}
<div{{ attrs }}>
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h3 class="h6 mb-1">
                    {{ nakki.definition.getName(app.request.locale) }}
                    <span class="text-muted fw-normal small">· {{ nakki.startAt|date('d.M H:i') }} – {{ nakki.endAt|date('H:i') }} · {{ this.displayIntervalHours }}h</span>
                </h3>
                {% set description = nakki.definition.getDescription(app.request.locale) %}
                {% if description %}
                    <div class="text-muted small">{{ description|raw }}</div>
                {% endif %}
            </div>
            <div class="d-flex flex-column align-items-end gap-2 ms-3">
            {% if nakki.responsible %}
                <div class="text-end small">
                    <span class="fw-semibold">{{ 'nakkikone.column.responsible'|trans }}:</span><br>
                    {{ nakki.responsible.name }}
                    {% if nakki.responsible.email %}
                        <br><span class="text-muted">{{ nakki.responsible.email }}</span>
                    {% endif %}
                </div>
            {% endif %}
            {% if nakki.mattermostChannel %}
                <div class="text-end small">
                    <span class="fw-semibold">{{ 'nakkikone.column.mattermost'|trans }}:</span>
                    <a href="{{ nakki.mattermostChannel }}" target="_blank" rel="noopener" class="ms-1">
                        {{ nakki.mattermostChannel }}
                    </a>
                </div>
            {% endif %}
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center border-top pt-3">
            <form class="form-check form-switch mb-0 d-flex align-items-center gap-2"
                  data-action="change->live#action"
                  data-live-action-param="saveDisable">
                <input class="form-check-input"
                    type="checkbox"
                    id="column-disable-{{ nakki.id }}"
                    data-model="disableBookings"
                    {% if this.disableBookings %}checked{% endif %}>
                <label class="form-check-label" for="column-disable-{{ nakki.id }}">
                    {{ 'nakkikone.column.disable'|trans }}
                </label>
            </form>
            <div class="d-flex gap-2">
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        data-action="live#action"
                        data-live-action-param="editColumn">
                    {{ 'nakkikone.column.edit_column'|trans }}
                </button>
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-action="live#action"
                        data-live-action-param="deleteColumn">
                    {{ 'nakkikone.column.remove_column'|trans }}
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">

        {% if this.error %}
            <div class="alert alert-warning" role="alert">{{ this.error }}</div>
        {% endif %}
        {% if this.notice %}
            <div class="alert alert-success" role="status">{{ this.notice }}</div>
        {% endif %}

        <div class="accordion mb-4" id="accordion-add-slots-{{ nakki.id }}">
            <div class="accordion-item">
                <h4 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-add-slots-{{ nakki.id }}" aria-expanded="false" aria-controls="collapse-add-slots-{{ nakki.id }}">
                        {{ 'nakkikone.column.add_multiple_slots'|trans }}
                    </button>
                </h4>
                <div id="collapse-add-slots-{{ nakki.id }}" class="accordion-collapse collapse" data-bs-parent="#accordion-add-slots-{{ nakki.id }}">
                    <div class="accordion-body">
                        <form class="row g-3 align-items-end"
                              data-action="live#action:prevent"
                              data-live-action-param="addSlots">
                            <div class="col-12">
                                <label class="form-label fw-semibold">{{ 'nakkikone.column.start_time'|trans }}</label>
                                <input type="datetime-local"
                                       class="form-control"
                                       data-model="newSlotStart"
                                       value="{{ this.newSlotStart }}">
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="form-label fw-semibold">{{ 'nakkikone.column.interval_hours'|trans }}</label>
                                <input type="number"
                                       min="1"
                                       class="form-control"
                                       data-model="newSlotIntervalHours"
                                       value="{{ this.newSlotIntervalHours }}">
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="form-label fw-semibold">{{ 'nakkikone.column.slots_field'|trans }}</label>
                                <input type="number"
                                       min="1"
                                       class="form-control"
                                       data-model="newSlotCount"
                                       value="{{ this.newSlotCount }}">
                            </div>
                            <div class="col-12 col-lg-4 text-lg-end">
                                <button type="submit" class="btn btn-outline-primary w-100">{{ 'nakkikone.column.add_button'|trans }}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <h4 class="h6 fw-semibold mb-3">{{ 'nakkikone.column.bookings_title'|trans }}</h4>

        {% set groups = this.bookingGroups %}
        {% if groups is empty %}
            <div class="text-center my-2">
                <button type="button"
                        class="btn btn-link text-muted text-decoration-none p-0"
                        data-action="live#action"
                        data-live-action-param="addSlotAfter"
                        title="{{ 'nakkikone.column.add_first_slot'|trans }}">
                    <span class="fs-4">➕</span>
                </button>
            </div>
        {% else %}
            <div class="text-center my-2">
                <button type="button"
                        class="btn btn-link text-muted text-decoration-none p-0"
                        data-action="live#action"
                        data-live-action-param="addSlotBefore"
                        title="{{ 'nakkikone.column.add_slot_before'|trans }}">
                    <span class="fs-4">➕</span>
                </button>
            </div>
            <div class="d-flex flex-column gap-3">
                {% for group in groups %}
                    <div class="border rounded p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="fw-semibold">
                                {{ group.start|date('d.M Y H:i') }} – {{ group.end|date('H:i') }}
                            </div>
                            <span class="badge bg-secondary">
                                {{ 'nakkikone.column.slots_badge'|trans({'%count%': group.bookings|length, count: group.bookings|length}) }}
                                · {{ this.displayIntervalHours }}h
                            </span>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            {% for booking in group.bookings %}
                                {% if booking.member %}
                                    <div class="d-flex align-items-center justify-content-between p-2 bg-light rounded">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary">{{ 'nakkikone.column.reserved'|trans }}</span>
                                            <span class="small">
                                                <strong>{{ booking.member.name }}</strong>
                                                {% if booking.member.email %}
                                                    <span class="text-muted">· {{ booking.member.email }}</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-between p-2 border rounded">
                                        <span class="badge bg-light text-secondary border">{{ 'nakkikone.column.available'|trans }}</span>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                aria-label="{{ 'nakkikone.column.remove_booking'|trans }}"
                                                data-action="live#action"
                                                data-live-action-param="removeSlot"
                                                data-live-booking-id-param="{{ booking.id }}">
                                            &minus;
                                        </button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary w-100"
                                    data-action="live#action"
                                    data-live-action-param="addSlotAtTime"
                                    data-live-start-time-param="{{ group.start|date('c') }}">
                                &plus; {{ 'nakkikone.column.add_slot_at_time'|trans }}
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="text-center my-2">
                <button type="button"
                        class="btn btn-link text-muted text-decoration-none p-0"
                        data-action="live#action"
                        data-live-action-param="addSlotAfter"
                        title="{{ 'nakkikone.column.add_slot_after'|trans }}">
                    <span class="fs-4">➕</span>
                </button>
            </div>
        {% endif %}
    </div>
</div>
