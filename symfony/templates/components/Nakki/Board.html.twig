{% set attrs = attributes.defaults({
    class: 'nakki-board',
    'data-controller': 'scroll-planner',
}) %}
<div{{ attrs }}>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            {% if event.url and not event.externalUrl %}
                {% set eventPath = path('entropy_event_slug.' ~ app.request.locale, {slug: event.url, year: event.eventDate|date('Y')}) %}
            {% else %}
                {% set eventPath = path('entropy_event.' ~ app.request.locale, {id: event.id}) %}
            {% endif %}
            <h1 class="h3 mb-1">
                <a href="{{ eventPath }}">{{ event.nameByLang(app.request.locale) }}</a>
            </h1>
            <small class="text-muted">{{ event.eventDate|date('d.m.Y H:i') }}</small>
        </div>
        <div class="btn-group" role="group">
            <a href="{{ path('entropy_event_slug_nakkikone', {year: event.eventDate.format('Y'), slug: event.url}) }}"
               class="btn btn-sm btn-outline-primary"
               target="_blank"
               title="{{ 'nakkikone.admin.view_public_page'|trans }}">
                {{ ux_icon('nakki-users', {class: 'icon-sm'}) }}
                <span class="d-none d-lg-inline ms-1">{{ 'nakkikone.admin.public_short'|trans }}</span>
            </a>
            <button type="button"
                    class="btn btn-sm {{ this.scheduleOnly ? 'btn-primary' : 'btn-outline-primary' }}"
                    data-action="live#action"
                    data-live-action-param="toggleSchedule"
                    title="{{ 'nakkikone.board.schedule_title'|trans }}">
                {{ ux_icon('nakki-calendar', {class: 'icon-sm'}) }}
                <span class="d-none d-lg-inline ms-1">{{ 'nakkikone.board.schedule_title'|trans }}</span>
            </button>
            <a href="{{ path('entropy_event_responsible', {year: event.eventDate.format('Y'), slug: event.url}) }}"
               class="btn btn-sm btn-outline-info"
               target="_blank"
               title="{{ 'nakkikone.admin.responsible_page'|trans }}">
                {{ ux_icon('nakki-id', {class: 'icon-sm'}) }}
                <span class="d-none d-lg-inline ms-1">{{ 'nakkikone.admin.responsible_short'|trans }}</span>
            </a>
            <a href="{{ path('admin_app_event_nakkiList', {id: event.id}) }}"
               class="btn btn-sm btn-outline-secondary"
               target="_blank"
               title="{{ 'nakkikone.admin.printable_list'|trans }}">
                {{ ux_icon('nakki-print', {class: 'icon-sm'}) }}
                <span class="d-none d-lg-inline ms-1">{{ 'nakkikone.admin.print_short'|trans }}</span>
            </a>
            <a href="{{ path('admin_app_event_edit', {id: event.id}) }}"
               class="btn btn-sm btn-outline-secondary"
               title="{{ 'nakkikone.admin.event_settings'|trans }}">
                {{ ux_icon('nakki-settings', {class: 'icon-sm'}) }}
                <span class="d-none d-lg-inline ms-1">{{ 'nakkikone.admin.settings_short'|trans }}</span>
            </a>
        </div>
    </div>

    {% if this.scheduleOnly %}
        <div class="card shadow-sm border-0" id="nakkikone-schedule">
            <div class="card-header bg-dark text-white">
                <h2 class="h5 mb-0">{{ 'nakkikone.board.schedule_title'|trans }}</h2>
            </div>
            <div class="card-body">
                {% set grid = this.scheduleGrid %}
                {% if grid.timeSlots is empty %}
                    <div class="alert alert-info mb-0">{{ 'nakkikone.board.schedule_no_bookings'|trans }}</div>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm table-striped nakkikone-schedule-table">
                            <thead>
                                <tr>
                                    <th class="nakkikone-schedule-time">{{ 'nakkikone.board.schedule_time'|trans }}</th>
                                    {% for i in 1..grid.maxColumns %}
                                        <th class="nakkikone-schedule-slot">{{ 'nakkikone.board.schedule_slot'|trans }} {{ i }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for slot in grid.timeSlots %}
                                    {% set rowIndex = loop.index0 %}
                                    <tr>
                                        <td class="fw-semibold align-middle nakkikone-schedule-time">
                                            {{ slot.time|date('H:i') }}
                                        </td>

                                        {% set columnMap = {} %}
                                        {% for bookingData in slot.bookings %}
                                            {% set columnMap = columnMap|merge({(bookingData.column): bookingData}) %}
                                        {% endfor %}

                                        {% for col in 0..(grid.maxColumns - 1) %}
                                            {% if columnMap[col] is defined %}
                                                {% set bookingData = columnMap[col] %}
                                                {% if bookingData.booking is not null %}
                                                    {% set booking = bookingData.booking %}
                                                <td rowspan="{{ bookingData.rowspan }}"
                                                    class="{{ booking.member ? 'table-success text-dark' : '' }} align-middle border-end nakkikone-schedule-cell">
                                                    <div class="fw-semibold">
                                                        {{ booking.nakki.definition.getName(app.request.locale) }}
                                                    </div>
                                                    {% if booking.member %}
                                                        <span class="badge bg-success mb-1">{{ 'nakkikone.column.reserved'|trans }}</span><br>
                                                        <strong>{{ booking.member.name }}</strong>
                                                        {% if booking.member.email %}
                                                            <br><small>{{ booking.member.email }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ 'nakkikone.column.available'|trans }}</span>
                                                    {% endif %}
                                                        <br>
                                                        {% if not booking.member %}
                                                            <small class="text-muted">
                                                                {{ booking.startAt|date('H:i') }}â€“{{ booking.endAt|date('H:i') }}
                                                                ({{ bookingData.rowspan }}h)
                                                            </small>
                                                        {% endif %}
                                                    </td>
                                                {% endif %}
                                            {% else %}
                                                <td class="border-end nakkikone-schedule-cell"></td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center" id="nakkikone-planner">
                <h2 class="h5 mb-0">{{ 'nakkikone.board.planner_title'|trans }}</h2>
            </div>
            <div class="card-body">
                {% if this.error %}
                    <div class="alert alert-warning" role="alert">{{ this.error }}</div>
                {% endif %}
                {% if this.message %}
                    <div class="alert alert-success" role="status">{{ this.message }}</div>
                {% endif %}

                <twig:Nakki:Definition :event="event" />

                {% if this.selectedDefinition %}
                    {{ form_start(form, {
                        attr: {
                            class: 'row g-3 align-items-end',
                            'data-action': 'live#action:prevent',
                            'data-live-action-param': 'addColumn',
                            autocomplete: 'off',
                        },
                    }) }}
                        <div class="d-none">
                            {{ form_widget(form.definition) }}
                        </div>

                        <div class="col-12">
                            <div class="row g-3">
                                <div class="col-6">
                                    {{ form_row(form.responsible) }}
                                </div>
                                <div class="col-6">
                                    {{ form_row(form.mattermostChannel) }}
                                </div>
                                <div class="col-12 col-lg-8 text-lg-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        {{ this.isDefinitionInUse() ? 'nakkikone.board.update_column'|trans : 'nakkikone.board.add_column'|trans }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    {{ form_end(form, {render_rest: false}) }}
                {% endif %}
            </div>
        </div>

        <div class="row row-cols-1 row-cols-lg-2 row-cols-xxl-3 g-3 mt-3">
            {% for nakki in this.columns %}
                <div class="col">
                    <twig:Nakki:Column :nakkiId="nakki.id" key="{{ nakki.id }}" />
                </div>
            {% else %}
                <div class="col">
                    <div class="alert alert-info mb-0">{{ 'nakkikone.board.no_columns'|trans }}</div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
