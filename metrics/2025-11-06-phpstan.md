# PHPStan Analysis - 2025-11-06

**Date**: 2025-11-06
**Level**: 5 (with Symfony + Doctrine extensions)
**Commit**: (current HEAD)
**Status**: ✅ **CLEAN** - No errors

---

## Summary

```
PHPStan 2.0.x
Level: 5
Result: No errors found
```

---

## Configuration

**File**: `symfony/phpstan.neon`

### Analysis Scope
- `src/` directory (all application code)
- Extensions enabled:
  - Symfony extension
  - Doctrine extension
  - PHPStan strict rules

### Exclusions
- `src/Admin/*` - Sonata admin classes (analyzed but with relaxed rules)
- Legacy/generated code paths (if any)

### Key Settings
```yaml
level: 5
paths:
    - src
```

---

## Historical Progress

### 2025-10-02 (Initial State)
**Status**: High error count (exact numbers in `metrics/phpstan-initial.md`)

**Major issues**:
- Missing generics annotations on Sonata Admin classes
- Nullability mismatches (Entity fields vs PHP types)
- Undefined property/method access
- Dead private properties
- Implicit mixed types

### 2025-10-17 (Post-Generics)
**Status**: Generics complete, remaining issues triaged

**Completed**:
- ✅ Added `@extends AbstractAdmin<Entity>` to all Admin classes
- ✅ Added `@extends CRUDController<Entity>` to all AdminControllers
- ✅ Fixed nullability batch 1 (Contract, Email, User, Member)
- ✅ Resolved most high-signal type issues

**Triaged** (in `metrics/phpstan-triage.md`):
- Return type completions
- DateTimeImmutable consistency
- Some entity method signatures

### 2025-11-06 (Current - CLEAN)
**Status**: ✅ **Zero errors at level 5**

**Achievements**:
- All previous issues resolved
- Nullability batch 2 completed (or suppressed with rationale)
- Type consistency maintained across codebase
- Clean baseline established

---

## Level Progression Strategy

### Current: Level 5 ✅
- **Enforces**:
  - Basic type checking
  - Method/property existence
  - Return type compatibility
  - Parameter type compatibility
  - Nullability basics

### Next: Level 6 (Future)
- **Adds**:
  - Stricter type checking
  - Better generic inference
  - More precise array types

**Blockers for level 6**:
- Need to audit mixed usage in services
- May require more precise Doctrine annotations
- Legacy code refactoring needed (EPicsService, SSHService)

### Max Level (Aspirational)
**Blockers**:
- Sonata PageBundle integration (loose types)
- Legacy service layer typing
- Complex Doctrine relations
- Symfony bundle type limitations

---

## Maintenance Policy

### Adding New Code
1. Must pass level 5 checks (enforced by pre-commit hook)
2. Avoid `@phpstan-ignore` without documented rationale
3. Use proper generic annotations for collections
4. Prefer explicit types over implicit mixed

### Suppression Policy
- Each `@phpstan-ignore` must include:
  - Reason comment
  - Expiration review date
  - Link to improvement task (if applicable)

### Review Cadence
- **Pre-commit**: `make stan-fast` (quick subset)
- **Pre-push**: `make stan` (full analysis)
- **Monthly**: Review suppression comments, plan for removal

---

## Tools & Commands

### Full Analysis
```bash
make stan                # Full analysis (level=5)
make stan-json          # JSON output to metrics/phpstan-report.json
```

### Fast Subset (Pre-commit)
```bash
make stan-fast          # Analyze src/ only (faster)
```

### Override Level (Testing)
```bash
make stan PHPSTAN_LEVEL=6    # Test at higher level
make stan PHPSTAN_LEVEL=max  # Test at maximum level
```

### Delta Analysis (Future)
```bash
make stan-delta         # Analyze only changed files (TODO: task MT30)
```

---

## Error Categories (Historical Reference)

### Fully Resolved ✅
- Generics (Admin/CRUDController)
- Nullability batch 1 (Contract, Email, User, Member)
- Return type completions (high-priority)
- DateTimeImmutable consistency (services migrated to ClockInterface)
- Undefined symbol/property access (Entity methods)
- Dead private properties (removed or justified)

### Remaining Work (If Raising Level)
- Mixed type elimination (services need explicit types)
- Array shape precision (especially in repositories)
- Legacy service refactoring (EPicsService, SSHService)
- Sonata integration type tightening (if possible with bundle updates)

---

## Integration with CI/CD

### Current
- ✅ Pre-commit hook runs `make stan-fast`
- ✅ Manual PR checks run `make stan`
- ⏳ CI pipeline integration (TODO)

### Recommended CI Setup
```yaml
# .github/workflows/quality.yml (example)
- name: PHPStan
  run: make stan

- name: PHPStan Report
  run: make stan-json
  if: always()

- name: Upload Report
  uses: actions/upload-artifact@v3
  with:
    name: phpstan-report
    path: metrics/phpstan-report.json
```

---

## Comparison with Mutation Testing

### Synergy
- Clean PHPStan → Better mutation test signal
- Generic annotations → Precise test expectations
- Type coverage → Fewer false mutation survivors

### Gaps
PHPStan doesn't catch:
- Business logic errors (mutation testing does)
- Boundary condition bugs (tests + mutation)
- Temporal logic errors (ClockInterface + tests)
- Missing negative path coverage (functional tests)

**Recommendation**: Use both for comprehensive quality assurance.

---

## Key Achievements (2025-10-02 → 2025-11-06)

1. ✅ **Zero PHPStan errors** (from ~hundreds initially)
2. ✅ **Generics coverage** complete (Admin/CRUD controllers)
3. ✅ **Nullability consistency** (Entity + Service layers)
4. ✅ **Clock abstraction** eliminating temporal type issues
5. ✅ **Clean baseline** for future maintenance

---

## Next Steps

### Immediate
- [ ] Document PHPStan clean state in README
- [ ] Add CI pipeline integration
- [ ] Create `make stan-delta` for changed-files-only analysis

### Future (Level 6+ Exploration)
- [ ] Audit for level 6 readiness
- [ ] Refactor legacy services (EPicsService, SSHService) for stricter types
- [ ] Evaluate Sonata bundle updates for better type support
- [ ] Consider phpstan-strict-rules extension

### Maintenance
- [ ] Monthly suppression comment review
- [ ] Quarterly level advancement evaluation
- [ ] Keep extensions updated (Symfony, Doctrine)

---

**Generated**: 2025-11-06
**Status**: ✅ Clean baseline established
**Next review**: 2025-12-06 (monthly maintenance check)
