# Test Suite Metrics - 2025-11-06

**Date**: 2025-11-06
**Commit**: (current HEAD)
**Context**: Post-documentation refactor baseline

---

## Test Suite Summary

### Overall Metrics
- **Total Tests**: 654
- **Total Assertions**: 3,877
- **Passed**: 650 tests (99.4%)
- **Errors**: 4 (Panther tests with SQLite transient issues)
- **Runtime**: ~2:48 minutes (168 seconds)
- **Memory**: 179 MB peak

### Test Distribution by Type
- **Unit Tests**: ~50 tests
- **Integration Tests**: ~25 tests
- **Functional Tests**: ~575 tests
- **Panther Tests**: 4 tests (browser/JavaScript)

---

## Code Coverage

### Overall Coverage
- **Lines**: 21.36% (2,355 / 11,020)
- **Methods**: 38.53% (1,077 / 2,795)
- **Classes**: 28.31% (225 / 795)

### Coverage by Layer

#### Entities (High Coverage)
- `Happening`: 98.90% lines, 98.18% methods
- `Nakki`: 100.00% lines, 100.00% methods
- `NakkiBooking`: 95.45% lines, 92.86% methods
- `RSVP`: 96.43% lines, 94.44% methods
- `StatusEvent`: 97.06% lines, 94.74% methods
- `Ticket`: 97.37% lines, 96.00% methods
- `Item`: 85.83% lines, 91.43% methods
- `Member`: 84.04% lines, 86.36% methods
- `Contract`: 81.48% lines, 82.35% methods
- `DoorLog`: 91.67% lines, 88.89% methods

#### Entities (Needs Improvement)
- `Event`: 30.50% lines, 42.46% methods (636 lines, 252 methods - large entity)
- `User`: 35.71% lines, 31.43% methods
- `Product`: 26.47% lines, 29.27% methods
- `Stream`: 33.33% lines, 28.57% methods
- `Reward`: 26.67% lines, 23.08% methods
- `HappeningBooking`: 20.00% lines, 18.18% methods
- `Cart`: 21.43% lines, 20.00% methods

#### Services (Well Covered)
- `BookingReferenceService`: 100.00% lines, 100.00% methods ✅
- `EmailVerifier`: 100.00% lines, 100.00% methods ✅
- `BarcodeService`: 100.00% lines, 100.00% methods ✅
- `QrService`: 100.00% lines, 100.00% methods ✅
- `MattermostNotifierService`: 100.00% lines, 100.00% methods ✅
- `NakkiDisplayService`: 100.00% lines, 100.00% methods ✅
- `ZMQService`: 85.71% lines, 83.33% methods

#### Services (Needs Coverage)
- `StripeService`: 44.29% lines, 50.00% methods
- `EPicsService`: 71.86% lines, 27.27% methods (complex legacy service)
- `SSHService`: 47.46% lines, 28.57% methods

#### Repositories
- `LocationRepository`: 100.00% lines, 100.00% methods ✅
- `NakkiRepository`: 100.00% lines, 100.00% methods ✅
- `StreamArtistRepository`: 66.67% lines, 33.33% methods
- `EventRepository`: 25.22% lines, 33.33% methods (115 lines, 12 methods)
- `EventArtistInfoRepository`: 9.09% lines, 50.00% methods
- `ItemRepository`: 5.56% lines, 33.33% methods
- `BookingRepository`: 4.17% lines, 33.33% methods
- `PackagesRepository`: 12.50% lines, 50.00% methods

#### Event Subscribers
- `LoginSubscriber`: 100.00% lines, 100.00% methods ✅
- `RSVPListener`: 100.00% lines, 100.00% methods ✅
- `BookingAdminSubscriber`: 94.00% lines, 80.00% methods
- `AuthorizationCodeSubscriber`: 82.35% lines, 66.67% methods
- `StripeEventSubscriber`: 4.33% lines, 20.00% methods (needs webhook tests)

#### Factories (Test Support)
- `SiteFactory`: 100.00% lines, 100.00% methods ✅
- `NakkiFactory`: 82.35% lines, 40.00% methods
- `NakkiDefinitionFactory`: 80.00% lines, 50.00% methods
- `PageFactory`: 65.52% lines, 40.00% methods
- `ArtistFactory`: 67.74% lines, 42.86% methods
- `MemberFactory`: 60.98% lines, 33.33% methods
- `EventFactory`: 34.21% lines, 13.64% methods (many state methods not exercised)
- `StreamFactory`: 70.00% lines, 50.00% methods

#### Page Services (Low Coverage - CMS Integration)
- `StreamPage`: 7.14% lines, 33.33% methods
- `ItemPage`: 25.00% lines, 33.33% methods
- `AnnouncementsPage`: 12.50% lines, 33.33% methods
- `EventsPage`: 3.70% lines, 25.00% methods
- `FrontPage`: 3.12% lines, 25.00% methods
- `DefaultPageService`: 4.76% lines, 33.33% methods

#### Security
- `EmailVerifier`: 100.00% lines, 100.00% methods ✅
- `MattermostAuthenticator`: 25.00% lines, 66.67% methods

#### Time Abstraction
- `AppClock`: 100.00% lines, 100.00% methods ✅
- `MutableClock`: 73.53% lines, 27.27% methods
- `FixedClock`: 66.67% lines, 25.00% methods

#### Twig Extensions
- `LocalizedUrlExtension`: 0.37% lines, 9.09% methods (271 lines!)

#### Story (Test Support)
- `CmsBaselineStory`: 70.23% lines, 27.27% methods

---

## Notable Improvements Since 2025-10-17

### Test Count
- **Then**: ~200 tests
- **Now**: 654 tests (+227% increase)

### Assertions
- **Then**: ~800-1000 (estimated)
- **Now**: 3,877 assertions

### Infrastructure
- ✅ Parallel execution stable (advisory locking)
- ✅ Clock abstraction in place
- ✅ Factory adoption complete
- ✅ Site-aware client requirement enforced
- ✅ Pre-commit hook available
- ✅ Documentation refactored and consolidated

---

## Test Categories Breakdown

### Functional Tests (Primary Focus)
Well-covered areas:
- ✅ Login flow (successful, invalid credentials, CSRF protection)
- ✅ Profile management (edit, password change, locale switching)
- ✅ Active member application flow
- ✅ Event visibility (published, draft, scheduled)
- ✅ Ticket purchase flow (cart, checkout, validation)
- ✅ Shop access timing (presale windows)
- ✅ Nakki booking system
- ✅ Stream workflow
- ✅ Admin access control
- ✅ Session management

Needs coverage:
- ⏳ Stripe webhook handling (checkout.session.completed, payment_intent.succeeded)
- ⏳ Payment failure scenarios
- ⏳ Concurrent purchase race conditions
- ⏳ Ticket delivery (email, PDF generation)
- ⏳ More event form validation scenarios

### Unit Tests
Well-covered:
- ✅ BookingReferenceService
- ✅ EmailVerifier
- ✅ QrService, BarcodeService
- ✅ MattermostNotifierService

Needs coverage:
- ⏳ Entity domain methods (Event, Product, Stream)
- ⏳ Value object logic
- ⏳ Repository custom queries
- ⏳ StripeService components

---

## Known Issues

### Panther Tests (4 errors)
- `StreamWorkflowPantherTest`: SQLite table already exists (transient)
- `NakkiWorkflowPantherTest`: SQLite readonly database error (permissions)
- `NakkiDefinitionComponentTest`: DAMA savepoint issues (mixing Panther + DAMA)

**Root cause**: Panther tests use separate SQLite DB that needs cleanup between runs.

**Fix needed**: Add SQLite cleanup in Panther test setUp or improve isolation.

---

## Coverage Exclusions (Intentional)

Per `phpunit.dist.xml`:
- `src/Admin/*` - Sonata configuration glue (low business value)

**Rationale**: Focus coverage budget on domain logic, security, and temporal logic rather than UI wiring.

---

## Performance Notes

### Runtime
- **Serial**: ~168 seconds (2:48)
- **Parallel** (typical): ~32-45 seconds (4-8 processes)
- **Memory**: 179 MB peak (reasonable for 654 tests)

### Slowest Areas (likely)
- Panther tests (browser startup overhead)
- Tests hitting external services (if any mocks missing)
- Complex factory graphs (Event + Products + Cart + Checkout chains)

---

## Next Steps (Priority Order)

### High Priority
1. Fix Panther test SQLite isolation issues
2. Add Stripe webhook integration tests
3. Improve Event entity coverage (currently 30%)
4. Add repository unit tests for custom queries

### Medium Priority
5. Expand Product entity coverage (currently 26%)
6. Add StripeService unit tests (currently 44%)
7. Complete form validation negative tests
8. Add bilingual data provider coverage for remaining functional tests

### Low Priority
9. PageService coverage (CMS integration - consider if needed)
10. LocalizedUrlExtension coverage (271 lines - refactor candidate?)
11. Factory state method coverage (many states unused in tests)

---

## Comparison with Earlier Baselines

### 2025-10-02 (Initial)
- Tests: 133
- Assertions: 673
- Runtime: 45.6s
- Coverage: Lines 20.91%, Methods 26.76%

### 2025-10-17 (Mid-refactor)
- Tests: ~200
- Runtime: ~32s (serial)
- Coverage: Lines ~21%, Methods ~27%

### 2025-11-06 (Current)
- Tests: 654 (+391% from initial)
- Assertions: 3,877 (+476% from initial)
- Runtime: 168s serial (parallelizable to ~35s)
- Coverage: Lines 21.36%, Methods 38.53%

**Key insight**: Massive test count increase with modest coverage improvement suggests:
- Good breadth (many scenarios covered)
- Opportunity for depth (unit tests for domain logic)
- Many entities/services have low coverage but high test count (functional tests don't execute all paths)

---

## Mutation Testing Readiness

Coverage is sufficient for baseline mutation testing in:
- ✅ Security layer (EmailVerifier, MattermostAuthenticator)
- ✅ Core services (BookingReferenceService, Barcode/QR services)
- ✅ High-coverage entities (Happening, Nakki, Ticket)

Needs improvement before mutation testing:
- ⏳ Event entity (too much uncovered code = noise)
- ⏳ Repository layer (custom queries not exercised)
- ⏳ StripeService (critical business logic)

---

**Generated**: 2025-11-06
**By**: Automated metrics extraction
**Next review**: After Panther test fixes + Stripe webhook coverage
