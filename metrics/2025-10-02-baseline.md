# Test Suite Metrics Baseline (Pre & Immediate Post Isolation)
Date: 2025-10-02
Commit: (fill with short SHA when committing this file)
Environment: Docker FPM container (PHP 8.x), transactional isolation introduced via DAMADoctrineTestBundle

## 1. Scope of This Baseline
This document captures:
- Original (pre‑isolation) full test suite metrics
- Immediate post‑isolation metrics after enabling transactional rollback + initial factory migrations
- Context required to interpret changes (assertion deltas, runtime shifts)
It serves as the reference point for subsequent optimization (factories expansion, mutation testing, static analysis hardening, parallelization).

## 2. Baseline (Initial State Before Structural Changes)
Suite Composition: Unit + Functional + Integration
Date Captured: 2025-10-02 (earliest snapshot before major refactors)
Metrics:
- Tests: 133
- Assertions: 673
- Wall Runtime: ~45.6s
- Coverage (Lines): 20.91%
- Coverage (Methods): 26.76%
- Coverage (Classes): 8.57%
Observations:
- High runtime driven by DB-bound functional tests loading broad fixtures.
- Unit coverage very small relative to functional reliance.
- Assertion density indicates some scenario-style tests (potentially over-broad).

## 3. Immediate Post-Isolation Snapshot
Change Introduced: Transactional isolation (DAMA) + removal of static EntityManager + early Foundry adoption for key entities.
Metrics (same day, after isolation enablement and initial pruning):
- Tests: 133 (no net change yet)
- Assertions: 655–670 (fluctuation during pruning; stabilized at 655 after removing redundant multi-hop persistence assertions)
- Wall Runtime: ~32.4s (≈29% improvement)
- Coverage (Lines): ~20.7% (noise-level change)
Interpretation:
- Runtime win primarily from eliminating per-test DB rebuild overhead and fixture side-effects.
- Slight assertion reduction acceptable: removed redundant indirect state confirmations made obsolete by deterministic isolation.

## 4. Unit Suite Micro-Baseline
(Recorded separately to understand isolated unit potential)
- Unit Tests: 32
- Assertions: 153
- Runtime: ~0.23s
- Coverage (Unit-only Lines): 2.31%
Signal:
- Unit layer underrepresented; future domain logic extraction can raise fast coverage without DB involvement.

## 5. Not Yet Collected (To Be Added Later)
- Mutation Score Indicator (MSI) baseline (infection) — pending initial focused namespace run.
- PHPStan initial finding counts (level=max with Doctrine + Symfony extensions) — pending (see tasks 31A–31C).
- Branch coverage (optional) — not yet measured.
- Parallel execution feasibility — not yet evaluated.
- Non-transactional nightly suite differential — not yet configured.

## 6. Initial Structural Changes Already Reflected
- Static shared EntityManager removed.
- DAMADoctrineTestBundle isolation enabled (`use_savepoints: true`).
- Foundry factories created for User, Member, Event, Artist (composite states: past, pastUnpublished, externalEvent, ticketedBasic, draft).
- Large scenario LoginTest decomposed into focused tests.
- Substring assertion purge started (replaced by selector-based + structural traits).
- Helper traits consolidated under tests/Support (LoginHelperTrait, LocaleDataProviderTrait, MetaAssertionTrait, FormErrorAssertionTrait).
- Session invalidation test added (security boundary).

## 7. Pending High-Value Next Steps (To Capture Deltas After Completion)
After completing the next execution slice, capture a follow-up snapshot (create metrics/2025-10-XX-post-slice.md):
1. Negative form coverage completion (Artist + Event forms).
2. Bilingual data provider expansion (events + dashboard).
3. Remaining substring assertions eliminated.
4. Event URL bilingual/external passthrough tests added.
5. Infection baseline run + record MSI (metrics/mutation-baseline.md).
6. PHPStan full run + record counts (metrics/phpstan-initial.md).

## 8. Interpretation Guidelines
- Runtime improvements: treat <5% variance as noise unless correlated with structural change.
- Assertion count drops: acceptable only if replaced by stronger structural/semantic checks (document rationale).
- Coverage plateaus: expected until unit-level domain logic tests are added; do not chase % via brittle tests.
- Mutation baseline: do NOT raise thresholds until glaring surviving mutants in core logic are addressed.

## 9. Data Collection Methodology (Repeatable)
Commands (illustrative; adapt to project scripts):
- Full suite: ./ci/test.sh (inside PHP 8.x FPM container)
- Coverage: same command with Xdebug/PCOV enabled (ensure consistent config)
- Mutation (later): vendor/bin/infection --threads=4 --min-msi=0 --min-covered-msi=0
- Static analysis (later): vendor/bin/phpstan analyse --memory-limit=1G

Record for each snapshot:
- Date & Commit
- Tests / Assertions
- Runtime (reported + wall)
- Coverage breakdown
- Notable structural changes since last snapshot
- Follow-up focus

## 10. Risks / Caveats at Baseline
- Transactional tests may mask flush-order or cascade issues (nightly non-transactional suite planned).
- Some assertions still content-fragment based (brittleness risk until purge completes).
- Limited unit isolation means mutation score may initially appear low—interpret in context.

## 11. Glossary
- MSI: Mutation Score Indicator (killed mutants / total relevant mutants).
- High-Signal PHPStan Issues: Type nullability mismatches, incorrect return types, entity mapping inconsistencies, unused private properties indicating dead code.

## 12. Checklist for Next Snapshot (Do Not Omit)
Before capturing the next metrics file, confirm:
[ ] All remaining substring assertions audited
[ ] Artist & Event negative form tests added
[ ] Event URL invariant tests implemented
[ ] Infection baseline executed & MSI logged
[ ] PHPStan counts captured (create phpstan-initial.md)

## 13. Snapshot Integrity Rule
Never retroactively edit this file after commit; append new snapshots as separate files to preserve historical traceability.

--- End of baseline snapshot ---