# Mutation Testing Baseline - 2025-11-06

**Date**: 2025-11-06
**Tool**: Infection PHP
**Commit**: (current HEAD)
**Context**: Fresh baseline after documentation refactor

---

## Executive Summary

Focused mutation testing on key application layers shows good test quality with room for improvement:

- **Security Layer**: MSI 47% (83% for covered code) - Moderate coverage, high kill rate when covered
- **Service Layer**: Testing in progress...

---

## Security Layer (`src/Security`)

### Overall Metrics
- **Total Mutants**: 76
- **Killed**: 30 (39%)
- **Escaped**: 6 (8%)
- **Uncovered**: 27 (36%)
- **Timeouts**: 0
- **Errors**: 0
- **Skipped**: 13 (17%)

### Quality Indicators
- **Mutation Score Indicator (MSI)**: 47%
- **Mutation Code Coverage**: 57%
- **Covered Code MSI**: 83% ✅

### Analysis

**Strengths**:
- ✅ **High covered code MSI (83%)**: When code is tested, tests are effective at catching mutations
- ✅ **Zero errors/timeouts**: Test suite is stable and deterministic
- ✅ **Good kill rate**: 30/36 covered mutants killed (83%)

**Weaknesses**:
- ⚠️ **Low coverage (57%)**: 27 mutants uncovered - need more tests for untested paths
- ⚠️ **6 escaped mutants**: Opportunities to strengthen existing tests

### Files Analyzed
Based on coverage data from test metrics:
- `EmailVerifier`: 100% line coverage → likely high MSI
- `MattermostAuthenticator`: 25% line coverage → likely source of uncovered mutants

### Recommended Actions
1. **Priority HIGH**: Add tests for uncovered paths in `MattermostAuthenticator`
   - OAuth token validation branches
   - Error handling paths
   - Edge cases in user creation

2. **Priority MEDIUM**: Review 6 escaped mutants
   - Run with `--show-mutations` to identify specific survivors
   - Add targeted assertions to kill survivors

3. **Priority LOW**: Investigate 13 skipped mutants
   - Review why they were skipped
   - Ensure no critical logic is being ignored

---

## Service Layer (`src/Service`)

### Testing Status
⏳ **In Progress** - Mutation test running...

### Expected Coverage (from test metrics)
- `BookingReferenceService`: 100% coverage → expect high MSI
- `BarcodeService`: 100% coverage → expect high MSI
- `QrService`: 100% coverage → expect high MSI
- `MattermostNotifierService`: 100% coverage → expect high MSI
- `NakkiDisplayService`: 100% coverage → expect high MSI
- `ZMQService`: 86% coverage → expect good MSI
- `StripeService`: 44% coverage → expect moderate MSI with uncovered mutants
- `EPicsService`: 72% coverage → mixed (complex legacy service)
- `SSHService`: 47% coverage → expect lower MSI

---

## Repository Layer (Future)

### Expected from Previous Baseline
- `LocationRepository`: 100% coverage
- `NakkiRepository`: 100% coverage
- `EventRepository`: 25% coverage (needs improvement)

**Status**: Not yet run (focusing on high-value layers first)

---

## Entity Layer (Future)

### High-Priority Entities
- `Event`: 30% coverage - **too low for meaningful mutation testing**
- `Product`: 26% coverage - **needs coverage improvement first**
- `Happening`: 99% coverage - **ready for mutation testing**
- `Nakki`: 100% coverage - **ready for mutation testing**
- `Ticket`: 97% coverage - **ready for mutation testing**

### Strategy
1. Run mutation tests only on high-coverage entities (>80%)
2. Use survivors to drive unit tests for domain logic
3. Defer low-coverage entities until coverage improves

---

## Historical Comparison

### 2025-10-08 Baseline
- **Security**: 0% MSI → improved with unit tests
- **Repository**: 100% covered MSI
- **Entity**: 95% MSI (10 survivors)

### 2025-11-06 Current
- **Security**: 47% MSI (57% coverage, 83% covered MSI)
- **Service**: Pending...
- **Repository**: Not yet re-run
- **Entity**: Not yet re-run

**Key Changes Since Oct**:
- Massive test count increase (133 → 654 tests)
- Factory adoption complete
- Clock abstraction added
- Security layer now has unit tests (EmailVerifier)

**Impact on Mutation**:
- Better coverage of happy paths
- Still need negative path coverage for mutation escapes
- Boundary condition tests needed (temporal logic, validation edges)

---

## Infection Configuration

**File**: `symfony/infection.json.dist`

### Key Settings
```json
{
    "source": {
        "directories": ["src"]
    },
    "logs": {
        "text": "build/infection/infection.log",
        "summary": "build/infection/summary.log",
        "html": "build/infection/html/index.html"
    },
    "mutators": {
        "@default": true
    },
    "minMsi": 0,
    "minCoveredMsi": 0
}
```

### Mutators Enabled
- All default mutators (conditionals, returns, math, assignments, etc.)
- No custom mutator configuration (using Infection defaults)

---

## Mutation Testing Strategy

### Phase 1: Establish Baselines (Current)
- ✅ Security layer complete (MSI 47%)
- ⏳ Service layer in progress
- ⏳ High-coverage entities (Happening, Nakki, Ticket)

### Phase 2: Address Escaped Mutants
- Review `--show-mutations` output
- Add targeted tests to kill survivors
- Focus on high-value business logic

### Phase 3: Improve Coverage
- Address uncovered mutants in Security layer (27 mutants)
- Add tests for low-coverage services (StripeService, MattermostAuthenticator)
- Expand entity method coverage

### Phase 4: Set Thresholds (Future)
- Once MSI > 70% for covered code, set `minCoveredMsi: 65`
- Gradually increase thresholds
- Add CI gating on mutation score

---

## Commands

### Run Focused Mutations
```bash
make infection FILTER=src/Security       # Security layer only
make infection FILTER=src/Service        # Service layer only
make infection FILTER=src/Repository     # Repository layer only
make infection FILTER=src/Entity         # Entity layer only
```

### Full Baseline (Slow)
```bash
make infection                           # All code (will take 30+ minutes)
```

### Show Escaped Mutants
```bash
docker compose exec -T fpm php vendor/bin/infection \
    --filter=src/Security \
    --show-mutations \
    --only-covered
```

### Baseline Report
```bash
make infection-baseline                  # Run and save results
```

---

## Integration with Coverage

### Synergy
Coverage shows **if** code is tested, mutation testing shows **how well** it's tested.

### Example: EmailVerifier
- Coverage: 100% lines ✅
- Expected MSI: High (likely 90%+)
- Interpretation: Well-tested with meaningful assertions

### Example: MattermostAuthenticator
- Coverage: 25% lines ⚠️
- Expected MSI: Low (likely <30%)
- Interpretation: Many paths untested, need more coverage first

### Strategy
1. Focus mutation testing on >80% coverage code
2. Use mutation escapes to improve assertion quality
3. Use uncovered mutants to guide new test creation

---

## Escaped Mutant Patterns (Common)

Based on historical analysis, common escape patterns:

### 1. Boundary Conditions
```php
// Original
if ($date > $now) { ... }

// Mutant (escaped)
if ($date >= $now) { ... }
```
**Fix**: Add test at exact boundary (`$date === $now`)

### 2. Inverted Boolean Returns
```php
// Original
return $user->isActive();

// Mutant (escaped)
return !$user->isActive();
```
**Fix**: Test both true and false cases explicitly

### 3. Math Operations
```php
// Original
$total = $price + $fee;

// Mutant (escaped)
$total = $price - $fee;
```
**Fix**: Assert exact totals, not just "is greater than zero"

### 4. Conditional Boundary Swap
```php
// Original
if ($count < 10) { ... }

// Mutant (escaped)
if ($count <= 10) { ... }
```
**Fix**: Test at boundary values (9, 10, 11)

---

## Next Steps (Priority Order)

### Immediate
1. Wait for Service layer mutation results
2. Review escaped mutants with `--show-mutations`
3. Document specific survivors needing tests

### Short Term
4. Add tests to kill Security layer escaped mutants (6)
5. Improve MattermostAuthenticator coverage → re-run mutations
6. Run mutations on high-coverage entities (Nakki, Happening, Ticket)

### Medium Term
7. Set up mutation testing in CI (advisory only, no gate)
8. Establish baseline for Repository layer
9. Track MSI trends over time

### Long Term
10. Achieve 70%+ covered MSI across all layers
11. Set CI threshold for covered MSI (start at 60%)
12. Gradually raise thresholds as tests improve

---

## Performance Notes

### Runtime (Security Layer)
- **Mutants Generated**: 76
- **Test Runs**: ~500-600 (approx 8-10 test runs per mutant)
- **Time**: 4 min 53 sec
- **Memory**: 22 MB
- **Threads**: 4

### Estimated Full Suite Runtime
- Security: ~5 min (76 mutants)
- Service: ~15-20 min (estimated 200+ mutants)
- Entity: ~30-40 min (estimated 400+ mutants)
- Repository: ~10 min (estimated 100 mutants)

**Total**: ~60-75 minutes for full baseline (should be run nightly, not on every commit)

---

## Troubleshooting

### Timeouts
If mutants timeout:
- Increase timeout in `infection.json.dist`: `"timeout": 30`
- Check for infinite loops in test setup
- Review slow tests with `make test-profile`

### Memory Issues
If OOM errors:
- Reduce thread count: `-j2` instead of `-j4`
- Increase PHP memory limit: `php -d memory_limit=512M`

### Flaky Tests
Mutation testing amplifies test flakiness:
- Fix flaky tests before mutation testing
- Ensure deterministic time (ClockInterface)
- Avoid external service calls (use mocks)

---

**Generated**: 2025-11-06
**Status**: Security layer complete, Service layer in progress
**Next Update**: After Service layer results available
